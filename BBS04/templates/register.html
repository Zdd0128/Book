<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    {% load static %}
    <link href="{% static 'bootstrap-3.4.1-dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <h3 class="text-center">注册页面</h3>
        <div class="col-md-4 col-lg-offset-4">
            <form id="my_form" novalidate>
                {% csrf_token %}
                {% for form in form_obj %}
                    <label for="{{ form.auto_id }}">{{ form.label }}:</label>
                    {{ form }}
                    <span class="pull-right" style="color: red"></span>
                {% endfor %}
                <br>
                <label for="avatar">上传头像:
                    <img id="img" style="border-radius: 50%;margin-left: 10px" height="100" src="/static/image/def.jpg"
                         alt="">
                </label>
                <input type="file" id="avatar" style="display: none">
            </form>
            <br>
            <button class="btn btn-block btn-success">注册</button>
        </div>
    </div>
</div>

<script>
    $('#avatar').change(function () {
        let fileReaderObj = new FileReader()
        let fileObj = $(this)[0].files[0]
        fileReaderObj.readAsDataURL(fileObj)
        fileReaderObj.onload = function () {
            $('#img').attr('src', fileReaderObj.result)
        }
    })

    $('.btn').on('click', function () {
        let formDataObj = new FormData()
        $.each($('#my_form').serializeArray(), function (index, obj) {
            formDataObj.append(obj.name, obj.value)
        })
        {#formDataObj.append('csrfmiddlewaretoken', '{{ csrf_token }}')#}
        formDataObj.append('avatar', $("#avatar")[0].files[0])
        $.ajax({
            url: '',
            type: 'post',
            data: formDataObj,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.code === 100) {
                    alert(data.msg)
                    window.location.href = data.url
                } else {

                    $.each(data.msg, function (name, errors) {
                        let inputId = '#id_' + name
                        console.log(inputId)
                        $(inputId).next().text(errors[0]).parent().addClass('has-error')
                    })
                }
            }
        })
        $('input').focus(function () {
            $(this).next().text('').parent().removeClass('has-error')
        })
    })


</script>
</body>
</html>